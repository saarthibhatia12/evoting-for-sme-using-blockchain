generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Shareholder {
  id            Int      @id @default(autoincrement())
  walletAddress String   @unique @map("wallet_address") @db.VarChar(42)
  name          String   @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  isActive      Boolean  @default(true) @map("is_active")
  isAdmin       Boolean  @default(false) @map("is_admin")
  shares        Share?
  votes         Vote[]
  
  // NEW: Quadratic voting - voter token balances
  voterTokenBalances VoterTokenBalance[]

  @@map("shareholders")
}

model Share {
  id            Int         @id @default(autoincrement())
  shareholderId Int         @unique @map("shareholder_id")
  shares        Int         @default(0)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  shareholder   Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

  @@map("shares")
}

model Proposal {
  id          Int      @id @default(autoincrement())
  proposalId  Int      @unique @map("proposal_id")
  title       String   @db.VarChar(500)
  description String?  @db.Text
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  votes       Vote[]
  
  // NEW: Quadratic voting support - ALL with safe defaults
  votingType  String   @default("simple") @map("voting_type") @db.VarChar(20)
  baseTokens  Int      @default(100) @map("base_tokens")
  voterTokens VoterTokenBalance[]

  @@map("proposals")
}

model AuthNonce {
  id            Int      @id @default(autoincrement())
  walletAddress String   @unique @map("wallet_address") @db.VarChar(42)
  nonce         String   @db.VarChar(255)
  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("auth_nonces")
}

model Vote {
  id            Int         @id @default(autoincrement())
  shareholderId Int         @map("shareholder_id")
  proposalId    Int         @map("proposal_id")
  voteChoice    Boolean     @map("vote_choice")
  txHash        String?     @map("tx_hash") @db.VarChar(66)
  votedAt       DateTime    @default(now()) @map("voted_at")
  proposal      Proposal    @relation(fields: [proposalId], references: [proposalId], onDelete: Cascade)
  shareholder   Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  
  // NEW: Quadratic voting fields with SAFE DEFAULTS
  voteWeight    Int         @default(1) @map("vote_weight")      // Default 1 for simple voting
  tokensSpent   Int         @default(0) @map("tokens_spent")     // Default 0 for simple voting

  @@unique([shareholderId, proposalId])
  @@index([proposalId], map: "votes_proposal_id_fkey")
  @@map("votes")
}

// NEW MODEL: Quadratic voting token balances per voter per proposal
model VoterTokenBalance {
  id            Int         @id @default(autoincrement())
  shareholderId Int         @map("shareholder_id")
  proposalId    Int         @map("proposal_id")
  totalTokens   Int         @map("total_tokens")
  tokensUsed    Int         @default(0) @map("tokens_used")
  voteDirection Boolean?    @map("vote_direction")  // null = not voted yet, true = YES, false = NO
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  shareholder   Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  proposal      Proposal    @relation(fields: [proposalId], references: [proposalId], onDelete: Cascade)
  
  @@unique([shareholderId, proposalId])
  @@index([proposalId], map: "voter_token_balances_proposal_id_fkey")
  @@map("voter_token_balances")
}
